import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  // Очистка базы данных
  await prisma.attempt.deleteMany();
  await prisma.question.deleteMany();
  await prisma.quiz.deleteMany();
  await prisma.lesson.deleteMany();
  await prisma.course.deleteMany();
  await prisma.user.deleteMany();

  // Создание пользователей
  const studentPasswordHash = await bcrypt.hash('user', 10);
  const hrPasswordHash = await bcrypt.hash('hr', 10);

  const student = await prisma.user.create({
    data: {
      username: 'user',
      passwordHash: studentPasswordHash,
      role: 'STUDENT',
      fullName: 'Demo Student',
      status: 'NEW',
      offerStatus: 'NONE',
    },
  });

  const hr = await prisma.user.create({
    data: {
      username: 'hr',
      passwordHash: hrPasswordHash,
      role: 'HR',
      fullName: 'Demo HR',
      status: 'NEW',
      offerStatus: 'NONE',
    },
  });

  // Создание основного курса
  const course = await prisma.course.create({
    data: {
      title: 'Основы работы риэлтора в агентстве недвижимости',
      description: 'Комплексный курс для начинающих риэлторов, охватывающий основы работы в агентстве недвижимости, этику, воронку продаж, работу с объектами и клиентами, а также дисциплину и отчётность.',
      isActive: true,
      createdByUserId: hr.id,
      lessons: {
        create: [
          {
            title: 'Роль риэлтора в агентстве и базовая этика',
            content: `Риэлтор в агентстве недвижимости играет ключевую роль в процессе купли-продажи недвижимости. Основные обязанности включают:

1. Поиск и привлечение клиентов (продавцов и покупателей)
2. Консультирование по вопросам недвижимости
3. Организация просмотров объектов
4. Ведение переговоров между сторонами
5. Подготовка документов для сделок
6. Сопровождение сделки до её завершения

Базовая этика риэлтора:
- Честность и прозрачность в работе с клиентами
- Соблюдение конфиденциальности информации
- Профессиональное отношение к коллегам
- Соблюдение законодательства и стандартов агентства
- Ответственность за свои действия и обещания`,
            order: 1,
          },
          {
            title: 'Воронка работы с клиентом: от лида до сделки',
            content: `Воронка продаж в недвижимости состоит из нескольких этапов:

1. Генерация лидов (Lead Generation)
   - Реклама, рекомендации, социальные сети
   - Холодные звонки и встречи

2. Квалификация лида (Lead Qualification)
   - Определение реальных потребностей клиента
   - Проверка финансовых возможностей
   - Уточнение сроков и приоритетов

3. Презентация объектов (Presentation)
   - Подбор подходящих вариантов
   - Организация просмотров
   - Демонстрация преимуществ

4. Переговоры (Negotiation)
   - Обсуждение условий сделки
   - Согласование цены и сроков
   - Работа с возражениями

5. Закрытие сделки (Closing)
   - Подготовка документов
   - Сопровождение до регистрации
   - Послепродажное обслуживание`,
            order: 2,
          },
          {
            title: 'Основы работы с объектами недвижимости (апартаменты, виллы и т.д.)',
            content: `Работа с объектами недвижимости требует глубокого понимания рынка:

Типы объектов:
- Апартаменты: городское жилье, популярно среди инвесторов и молодых семей
- Виллы: премиальное жилье, требует особого подхода к клиентам
- Коммерческая недвижимость: офисы, магазины, склады
- Земельные участки: для строительства или инвестиций

Ключевые аспекты работы:
1. Оценка объекта: анализ рынка, сравнение с аналогами
2. Фотосъёмка и описание: качественные материалы для презентации
3. Ценообразование: баланс между желанием продавца и рыночной стоимостью
4. Презентация преимуществ: уникальные особенности объекта
5. Работа с документами: проверка прав собственности, обременений

Важно понимать специфику каждого типа объекта и уметь правильно презентовать его преимущества клиентам.`,
            order: 3,
          },
          {
            title: 'Коммуникация с клиентом: первый контакт, уточнение потребностей',
            content: `Эффективная коммуникация - основа успешной работы риэлтора:

Первый контакт:
- Установление доверия с первых секунд разговора
- Активное слушание и эмпатия
- Профессиональный внешний вид и манеры
- Пунктуальность и соблюдение договорённостей

Уточнение потребностей (техника SPIN):
- Ситуационные вопросы: текущая ситуация клиента
- Проблемные вопросы: выявление болевых точек
- Извлекающие вопросы: последствия текущей ситуации
- Направляющие вопросы: подведение к решению

Работа с возражениями:
- Признание точки зрения клиента
- Выяснение истинной причины возражения
- Предоставление аргументов и доказательств
- Мягкое подведение к решению

Важно помнить: клиент покупает не просто недвижимость, а решение своей задачи (новый дом, инвестиция, статус и т.д.).`,
            order: 4,
          },
          {
            title: 'Дисциплина, отчётность и работа в CRM',
            content: `Дисциплина и системность - залог успеха в работе риэлтора:

Ежедневная дисциплина:
- Планирование дня и приоритизация задач
- Регулярные звонки и встречи с клиентами
- Актуализация базы объектов
- Работа с новыми лидами

Отчётность:
- Еженедельные отчёты о проделанной работе
- Отслеживание метрик: количество звонков, встреч, сделок
- Анализ воронки продаж
- Планирование на следующий период

Работа в CRM (Customer Relationship Management):
- Ведение базы клиентов и объектов
- Отслеживание истории взаимодействий
- Напоминания о важных событиях
- Аналитика и отчёты

Преимущества CRM:
- Ничего не забывается
- Быстрый доступ к информации
- Автоматизация рутинных задач
- Анализ эффективности работы

Помните: успешный риэлтор - это не только продавец, но и менеджер своего времени и ресурсов.`,
            order: 5,
          },
        ],
      },
      quiz: {
        create: {
          title: 'Итоговый тест по основам работы риэлтора',
          description: 'Проверьте свои знания, полученные в ходе прохождения курса',
          questions: {
            create: [
              {
                text: 'Какая из перечисленных обязанностей НЕ относится к основным обязанностям риэлтора?',
                options: JSON.stringify([
                  'Поиск и привлечение клиентов',
                  'Консультирование по вопросам недвижимости',
                  'Организация просмотров объектов',
                  'Проведение строительных работ',
                ]),
                correctOptionIndex: 3,
                weight: 10,
              },
              {
                text: 'Какой этап воронки продаж следует после квалификации лида?',
                options: JSON.stringify([
                  'Генерация лидов',
                  'Презентация объектов',
                  'Закрытие сделки',
                  'Переговоры',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
              {
                text: 'Что означает техника SPIN в коммуникации с клиентом?',
                options: JSON.stringify([
                  'Система продаж недвижимости',
                  'Метод уточнения потребностей через вопросы',
                  'Способ презентации объектов',
                  'Техника работы с возражениями',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
              {
                text: 'Какой тип объекта недвижимости обычно требует особого подхода к клиентам?',
                options: JSON.stringify([
                  'Апартаменты',
                  'Виллы',
                  'Коммерческая недвижимость',
                  'Все перечисленные',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
              {
                text: 'Что является основой успешной работы риэлтора?',
                options: JSON.stringify([
                  'Только знание рынка',
                  'Только коммуникативные навыки',
                  'Дисциплина, системность и профессиональные навыки',
                  'Только наличие клиентской базы',
                ]),
                correctOptionIndex: 2,
                weight: 10,
              },
              {
                text: 'Какое качество НЕ относится к базовой этике риэлтора?',
                options: JSON.stringify([
                  'Честность и прозрачность',
                  'Соблюдение конфиденциальности',
                  'Манипулирование клиентами',
                  'Профессиональное отношение к коллегам',
                ]),
                correctOptionIndex: 2,
                weight: 10,
              },
              {
                text: 'Что включает в себя этап "Переговоры" в воронке продаж?',
                options: JSON.stringify([
                  'Только обсуждение цены',
                  'Обсуждение условий сделки, согласование цены и сроков, работа с возражениями',
                  'Только подготовку документов',
                  'Только организацию просмотров',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
              {
                text: 'Что важно понимать при работе с объектами недвижимости?',
                options: JSON.stringify([
                  'Только цену объекта',
                  'Специфику каждого типа объекта и умение правильно презентовать преимущества',
                  'Только местоположение',
                  'Только площадь объекта',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
              {
                text: 'Что покупает клиент при приобретении недвижимости?',
                options: JSON.stringify([
                  'Только квадратные метры',
                  'Решение своей задачи (новый дом, инвестиция, статус и т.д.)',
                  'Только документы',
                  'Только объект',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
              {
                text: 'Какие преимущества даёт работа в CRM?',
                options: JSON.stringify([
                  'Только хранение данных',
                  'Ведение базы, отслеживание истории, автоматизация задач, аналитика',
                  'Только напоминания',
                  'Только отчёты',
                ]),
                correctOptionIndex: 1,
                weight: 10,
              },
            ],
          },
        },
      },
    },
  });

  console.log('Seed completed successfully!');
  console.log('Created users:', { student: student.username, hr: hr.username });
  console.log('Created course:', course.title);
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

